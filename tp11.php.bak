<?php
    //header("Content-type:text/html; charset=utf-8")
    ignore_user_abort(); //后台运行
    set_time_limit(0); //取消脚本运行时间的超时上限
	
    //获取源码
    function hqym($url){
        $ch = curl_init();
  	    //设置浏览器的特定header
   	    curl_setopt($ch, CURLOPT_HTTPHEADER, array(
 	      "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
       	  "Accept-Language: zh-CN,zh;q=0.9",
 	      'Cookie: __cfduid=d5630ed9a5e21a18ce10e9a1651c702e519',		
		));
   		curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36');
 	    //在HTTP请求头中"Referer: "的内容。
 	    curl_setopt($ch, CURLOPT_REFERER,"https://www.pixiv.net");
  	    curl_setopt($ch, CURLOPT_ENCODING, "gzip, deflate, sdch");
 	    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
   	    curl_setopt($ch, CURLOPT_URL, $url);
 		curl_setopt($ch, CURLOPT_TIMEOUT,120);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);//302redirect
	  	$info = curl_exec($ch);
        return $info;
    }

	//转换链接
    function tpurlzh($jqylj){  
	$jqylj1 = substr($jqylj,strpos($jqylj,'/')+4);
	$jqlj = substr($jqylj1,strpos($jqylj1,'/')+0);
	return "https://i.pixiv.cat".$jqlj;
	}
	
    //获取链接
    function page($url,$Count){
$search = "_p0";
$replace = "_p";
$array = array();
for($i=0; $i<$Count;$i++){
    $array[$i] = str_ireplace($search, $replace.$i, $url);
}
return $array;
}
    
    //转换tag
	function zhtag($tags){
		$htmltd = "";
        for($i=0; $i<count($tags);$i++){
		    if($i != 0){
		        $htmltd = $htmltd.','.$tags[$i]['tag'];
		    }else{
		        $htmltd = $tags[$i]['tag'];
		    }
		}
	    return $htmltd;
	}
	
	function imgs($imgs){
	for($i=0; $i<count($imgs);$i++){
	echo '<img width="90%" src="'.$imgs[$i].'" /><br/>';
	}
	}
	
	function userIllusts($userIllusts){
	$keys = array_keys($userIllusts);
for($i=0; $i<count($keys);$i++){
$illust = $userIllusts[$keys[$i]];
if($illust != null){
$id = $illust["id"];//PID
$title = $illust["title"];//标题
$alt = $illust["alt"];//介绍说明
$userName = $illust['userName'];//作者名
$userId = $illust["userId"];//UID
$pageCount = $illust['pageCount'];//图片数量

$url = $illust["url"];//链接组
$width = $illust['width'];//原图宽度
$height = $illust['height'];//原图高度
echo "<div><a>".$title."|".$pageCount.'<br><img width="20%" src="'.tpurlzh($url).'" /></a></div>';
}
}
}
	
	function zengoIdWorks($zengoIdWorks){
for($i=0; $i<count($zengoIdWorks);$i++){
$illust = $zengoIdWorks[$i];
$id = $illust["id"];//PID
$title = $illust["title"];//标题
$alt = $illust["alt"];//介绍说明
$userName = $illust['userName'];//作者名
$userId = $illust["userId"];//UID
$pageCount = $illust['pageCount'];//图片数量

$url = $illust["url"];//链接组
$width = $illust['width'];//原图宽度
$height = $illust['height'];//原图高度
echo "<br><a>".$title."|".$pageCount.'<br><img width="20%" src="'.tpurlzh($url).'" /></a>';
}
}
    
    $pig = $_GET['id'];
    
    //$txte='../a.txt';
    //$txt='1.txt';
	//$bbs=file($txte);
    
	//$b12=file($txte);
   
    //$c123=count($b12);
    
    //echo $c123.'<br/>';
    
        
    //sleep(0.2);
    
    
    //preg_match('|p1id(.*?)p1idt1p|i',$bbs[1],$pidaa);
    //$url = "https://www.pixiv.net/artworks/".$pidaa[1] ;
    
    $url = "https://www.pixiv.net/artworks/".$pig;
    $info = hqym($url);
    //echo $info;

//转换成json
preg_match('|"id":"(.*?)","title|i',$info,$pid);
preg_match('|timestamp(.*?)\S>|i',$info,$sqj);
$json = '{"timestamp'.$sqj[1];
$jsons = json_decode($json,true);

$illust = array_keys($jsons['illust'])[0];

$illust = $jsons['illust'][$illust];


$id = $illust["id"];//PID
$title = $illust["title"];//标题
$description = $illust["description"];//详细介绍说明
$userName = $illust['userName'];//作者名
$userId = $illust["userId"];//UID
$viewCount = $illust['viewCount'];//图片预览次数

$pageCount = $illust['pageCount'];//图片数量
$urls = $illust["urls"];//链接组
$mini = $urls["mini"];//缩略图 -- 48x48
$thumb = $urls["thumb"];//小图 -- 250x250_80_a2
$small = $urls["small"];//中图 -- 540x540_70
$regular = $urls["regular"];//大图 -- img-master
$original = $urls["original"];//原图 -- img-original

$width = $illust['width'];//原图宽度
$height = $illust['height'];//原图高度

$tags = $illust["tags"]['tags'];//获取全部tag
$htmltd = zhtag($tags);

$userIllusts = $illust['userIllusts'];//作者作品列表

$meta = $illust['extraData']['meta'];//额外信息
$meta_title = $meta['title'];//网页标题
$meta_descriptionHeader = $meta['descriptionHeader'];//本作品关键词说明
$meta_canonical = $meta['canonical'];//本作品链接

$zengoIdWorks = $illust['noLoginData']['zengoIdWorks'];//未登录推荐作品列表


//var_dump($jsons);

//$api = "z1z".$author[1]."z1z"."b1t".$title[1]."b1t"."u1id".$uid[1]."ui1d"."p1id".$pid[1]."p1id"."t1p".$tpurl."t1p" ;
/*
$api = "u1s".$userName."us1e"."ti1t".$title."t1it"."p1d".$id."pid"."ta1g".$htmltd."t1s" ;

$data = file_get_contents($txt);

$stop='dta1g';
$sj=$data;

$db='/'.$pid[1].'(.+?)'.$stop.'/';
preg_match($db,$sj,$wc);

$pd = "pi";

$srk ='<h1>请输入图片Pid：<input value="" type="图片Pid" id="aa" style="width:50%; height:80px; font-size:40px; background-color:#ffffff; "/>
       </h1>	
		<button onclick="cc()" style="width:50%; height:80px; font-size:40px; background-color:#ffffff; ">添加</button>
		<a href="/"><input style="width:20%; height:60px; font-size:30px; background-color:#ffffff; " type="button" id="btn1"  value="返回" onclick="window.location.href("/")"/></a>
		<script type="text/javascript">
			function cc(){
				var aa=document.getElementById("aa").value;
				window.location.href="tp1.php?data="+aa;
			}
		</script>';

$cz = "<h1>图片已存在</h1>";
$fr = "<h1>图片已添加到库";
$srcw = "<h1>Pid错误或无效，请检查Pid是否有效</h1>";

//$a='data.txt';

//echo $wc[1];

if ($wc[1] == $pd){
	//echo $srk;
	echo $cz;//图片已存在
}
elseif (is_numeric($_GET['data'])) {
	/*$b1=file($txt);
    $c1=count($b1);
    $handle=fopen($txt,"a+");
    $str=fwrite($handle,"\n$api");
    fclose($handle);
//	echo $fr."，这是第".$c1."张</h1>";//图片已添加到库
	$jisuj = $jisuj+1;
    *
    echo '已添加';
}
else {
	//echo $srk;
	echo $srcw;//Pid错误或无效
}
*/
$mini = tpurlzh($mini);
$thumb = tpurlzh($thumb);
$small = tpurlzh($small);
$regular = tpurlzh($regular);
$original = tpurlzh($original);

//if (is_numeric($_GRT['data'])){
	
	echo '<h3>
	
		标题：'.$title.'<br/><br/>
		
		作者：'.$userName.'<br/><br/>
		
		UID：'.$userId.'<br/><br/>
		
		PID：'.$id.'<br/><br/>
		
		关键词：'.$htmltd.'<br/><br/>';

	echo '<!--链接：'.$original.'-->
		<a href="https://i.pixiv.cat'.$original.'" download="'.$title.'">下载原图</a>
		</h3>
		缩略图<br/>
		<img width="" src="'.$mini.'" /><br/>
		小<br/>
		<img width="" src="'.$thumb.'" /><br/>
		中<br/>
		<img width="" src="'.$small.'" /><br/>
		大<br/>
		<img width="80%" src="'.$regular.'" /><br/>
		原图<br/>
		<img width="100%" src="'.$original.'" /><br/>';
//}
echo "图片列表:";
imgs(page($original,$pageCount));
echo "作者作品:";
userIllusts($userIllusts);
echo "相关作品";
zengoIdWorks($zengoIdWorks);

var_dump($jsons);
exit;
?>