<?php

    ignore_user_abort(); // 后台运行
    set_time_limit(0); // 取消脚本运行时间的超时上限


//截取图片链接
function tpurljq($jqylj){   
    $jqylj1 = substr($jqylj,strpos($jqylj,'/')+4);
    $jqlj = substr($jqylj1,strpos($jqylj1,'/')+0);
    return $jqlj;
}

function text(){
    $txte='a.txt';
    $txt='1.txt';
    $bbs=file($txte);

    //$txt='data2.txt';

    $b12=file($txte);
    $c123=count($b12);
    echo $c123.'<br/>';
    for ($i = 5830; $i < 6045 ; $i++) {
        sleep(0.2);
        preg_match('|p1id(.*?)p1idt1p|i',$bbs[$i],$pidaa);
    }
}

$pidaa = $_REQUEST['id'];
$wpid = "70678725";

if ($pidaa == ""){
   $pidaa = $wpid;
}

$url = "https://www.pixiv.net/artworks/".$pidaa;

$ch = curl_init();
    // 设置浏览器的特定header
    curl_setopt($ch, CURLOPT_HTTPHEADER, array(
        "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
        "Accept-Language: zh-CN,zh;q=0.9",
        'Cookie: __cfduid=d5630ed9a5e21a18ce10e9a1651c702e519',
));
    curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36');
    // 在HTTP请求头中"Referer: "的内容。
    curl_setopt($ch, CURLOPT_REFERER,"https://www.pixiv.net");
    curl_setopt($ch, CURLOPT_ENCODING, "gzip, deflate, sdch");
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_TIMEOUT,120);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);//302redirect

    $info = curl_exec($ch);
//echo $info;
preg_match('|"id":"(.*?)","title|i',$info,$pid);

preg_match('|timestamp(.*?)\S>|i',$info,$sqj);

$json = '{"timestamp'.$sqj[1];

$pids = $pid[1];

$turl  = $yurl[1];

$jsons = json_decode($json,true);
$illust = $jsons['illust'];
$illust = $illust["$pids"];

$id = $illust["id"];//PID
$title = $illust["title"];//标题
$description = $illust["description"];//名

$urls = $illust["urls"];//链接组

$mini = $urls["mini"];//缩略图 -- 48x48
$thumb = $urls["thumb"];//小图 -- 250x250_80_a2
$small = $urls["small"];//中图 -- 540x540_70
$regular = $urls["regular"];//大图 -- img-master
$original = $urls["original"];//原图 -- img-original

$tags = $illust["tags"];//获取全部tag
$userId = $tags["authorId"];
$tags = $tags["tags"];

//转换tag

$tag01 = $tags["0"];
$tag0 = $tag01['tag'];
$tag1 = $tags["1"];
$tag1 = $tag1['tag'];
$tag2 = $tags["2"];
$tag2 = $tag2['tag'];
$tag3 = $tags["3"];
$tag3 = $tag3['tag'];
$tag4 = $tags["4"];
$tag4 = $tag4['tag'];
$tag5 = $tags["5"];
$tag5 = $tag5['tag'];
$tag6 = $tags["6"];
$tag6 = $tag6['tag'];
$tag7 = $tags["7"];
$tag7 = $tag7['tag'];
$tag8 = $tags["8"];
$tag8 = $tag8['tag'];
$tag9 = $tags["9"];
$tag9 = $tag9['tag'];
$tag10 = $tags["10"];
$tag10 = $tag10['tag'];
$tag11 = $tags["11"];
$tag11 = $tag11['tag'];
$tag12 = $tags["12"];
$tag12 = $tag12['tag'];
$tag13 = $tags["13"];
$tag13 = $tag13['tag'];
$tag14 = $tags["14"];
$tag14 = $tag14['tag'];
$tag15 = $tags["15"];
$tag15 = $tag15['tag'];
$tag16 = $tags["16"];
$tag16 = $tag16['tag'];
$tag17 = $tags["17"];
$tag17 = $tag17['tag'];
$tag18 = $tags["18"];
$tag18 = $tag18['tag'];
$tag19 = $tags["19"];
$tag19 = $tag19['tag'];
$tag20 = $tags["20"];
$tag20 = $tag20['tag'];

$userName = $tag01['userName'];//作者名

if (is_numeric($userId)){
//$htmltd = '<h3>关键词：</h3>';
}

//判断tag数量输出tag

if ($tags['0']) {$htmltd = $htmltd.$tag0;
if ($tags['1']) {$htmltd = $htmltd.','.$tag1;
if ($tags['2']) {$htmltd = $htmltd.','.$tag2;
if ($tags['3']) {$htmltd = $htmltd.','.$tag3;
if ($tags['4']) {$htmltd = $htmltd.','.$tag4;
if ($tags['5']) {$htmltd = $htmltd.','.$tag5;
if ($tags['6']) {$htmltd = $htmltd.','.$tag6;
if ($tags['7']) {$htmltd = $htmltd.','.$tag7;
if ($tags['8']) {$htmltd = $htmltd.','.$tag8;
if ($tags['9']) {$htmltd = $htmltd.','.$tag9;
if ($tags['10']) {$htmltd = $htmltd.','.$tag10;
if ($tags['11']) {$htmltd = $htmltd.','.$tag11;
if ($tags['12']) {$htmltd = $htmltd.','.$tag12;
if ($tags['13']) {$htmltd = $htmltd.','.$tag13;
if ($tags['14']) {$htmltd = $htmltd.','.$tag14;
if ($tags['15']) {$htmltd = $htmltd.','.$tag15;
if ($tags['16']) {$htmltd = $htmltd.','.$tag16;
if ($tags['17']) {$htmltd = $htmltd.','.$tag17;
if ($tags['18']) {$htmltd = $htmltd.','.$tag18;
if ($tags['19']) {$htmltd = $htmltd.','.$tag19;
if ($tags['20']) {$htmltd = $htmltd.','.$tag20;

}else {}
}else {}
}else {}
}else {}
}else {}
}else {}
}else {}
}else {}
}else {}
}else {}
}else {}
}else {}
}else {}
}else {}
}else {}
}else {}
}else {}
}else {}
}else {}
}else {}
}else {}

//var_dump($jsons);

$cz = "<h1>图片已存在</h1>";
$fr = "<h1>图片已添加到库";
$srcw = "<h1>Pid错误或无效，请检查Pid是否有效</h1>";
$srk ='<!DOCTYPE html>
<html lang="zh" id="html">
<head><title>随机图</title></head><body><h1>请输入图片Pid：<input value="'.$pidaa.'" type="图片Pid" id="aa" style="width:50%; height:80px; font-size:40px; background-color:#ffffff; "/>
       </h1>
<button onclick="cc()" style="width:20%; height:60px; font-size:30px; background-color:#ffffff; ">查看</button>
<a href="/"><input style="width:20%; height:60px; font-size:30px; background-color:#ffffff; " type="button" id="btn1"  value="返回" onclick="window.location.href("/")"/></a>
<script type="text/javascript">
function cc(){
document.getElementById("loading").style.display="block";
var aa=document.getElementById("aa").value;
window.location.href="?id="+aa;
}
</script>';

function bctext(){
//$api = "z1z".$author[1]."z1z"."b1t".$title[1]."b1t"."u1id".$uid[1]."ui1d"."p1id".$pid[1]."p1id"."t1p".$tpurl."t1p" ;
$api = "u1s".$userName."us1e"."ti1t".$title."t1it"."p1d".$id."pid"."ta1g".$htmltd."t1s" ;
$data = file_get_contents($txt);

$stop='dta1g';
$sj=$data;

$db='/'.$pid[1].'(.+?)'.$stop.'/';
preg_match($db,$sj,$wc);

$pd = "pi";

$s1 = "1";
//$a='data.txt';

//echo $wc[1];

if ($wc[1] == $pd){
//echo $srk;
echo $cz;//图片已存在
}
elseif (is_numeric($pid[1])) {

$b1=file($txt);
    $c1=count($b1);
    $handle=fopen($txt,"a+");
    $str=fwrite($handle,"\n$api");
    fclose($handle);
//echo $fr."，这是第".$c1."张</h1>";//图片已添加到库
$jisuj = $jisuj+1;
}
else {
//echo $srk;
echo $srcw;//Pid错误或无效
}
}


$mini = tpurljq($mini);
$thumb = tpurljq($thumb);
$small = tpurljq($small);
$regular = tpurljq($regular);
$original = tpurljq($original);


echo $srk;
echo '
<style type="text/css">
#loading {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 999;
}

#loading i {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  width: 100px;
  height: 100px;
  border: 15px solid #66ccff;
  border-right-color: transparent;
  border-radius: 50%;
  animation: loadingAnimation 0.8s infinite Linear;
  margin: auto;
}

@keyframes loadingAnimation {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}
</style>
<div id="loading">
  <i></i>
</div>
';
if ($pidaa == $id){

echo '
<h3>

标题：'.$title.'<br/><br/>

作者：'.$userName.'<br/><br/>

UID：'.$userId.'<br/><br/>

PID：'.$id.'<br/><br/>

关键词：'.$htmltd.'<br/><br/>';

echo '<!--链接：'.$original.'-->
</h3>
<div>
<button onclick="slt()" style="width:18%; height:60px; font-size:30px; background-color:#ffffff; ">缩略图</button>
<button onclick="xt()" style="width:18%; height:60px; font-size:30px; background-color:#ffffff; ">小图</button>
<button onclick="zt()" style="width:18%; height:60px; font-size:30px; background-color:#ffffff; ">中图</button>
<button onclick="dt()" style="width:18%; height:60px; font-size:30px; background-color:#ffffff; ">大图</button>
<button onclick="yt()" style="width:18%; height:60px; font-size:30px; background-color:#ffffff; ">原图</button>
</div><br><br><br>
<script>
function slt(){
document.getElementById("slt").style.display="block";
document.getElementById("xt").style.display="none";
document.getElementById("zt").style.display="none";
document.getElementById("dt").style.display="none";
document.getElementById("yt").style.display="none";
}
function xt(){
document.getElementById("slt").style.display="none";
document.getElementById("xt").style.display="block";
document.getElementById("zt").style.display="none";
document.getElementById("dt").style.display="none";
document.getElementById("yt").style.display="none";
}
function zt(){
document.getElementById("slt").style.display="none";
document.getElementById("xt").style.display="none";
document.getElementById("zt").style.display="block";
document.getElementById("dt").style.display="none";
document.getElementById("yt").style.display="none";
}
function dt(){
document.getElementById("slt").style.display="none";
document.getElementById("xt").style.display="none";
document.getElementById("zt").style.display="none";
document.getElementById("dt").style.display="block";
document.getElementById("yt").style.display="none";
}
function yt(){
document.getElementById("slt").style.display="none";
document.getElementById("xt").style.display="none";
document.getElementById("zt").style.display="none";
document.getElementById("dt").style.display="none";
document.getElementById("yt").style.display="block";
}

</script>
<div align="center">

<div id="slt" style="display: none;left:50%;">
<img width="" src="https://i.pixiv.cat'.$mini.'" /><br>48x</div>

<div id="xt" style="display: none;left:50%;">
<img width="" src="https://i.pixiv.cat'.$thumb.'" /><br>250x</div>

<div id="zt" style="display: block;left:50%;">
<img width="" src="https://i.pixiv.cat'.$small.'" /><br>540x</div>

<div id="dt" style="display: none;left:50%;">
<img width="80%" src="https://i.pixiv.cat'.$regular.'" /><br>725x</div>

<div id="yt" style="display: none;left:50%;">
<img width="100%" src="https://i.pixiv.cat'.$original.'" /></div>

</div>
';
}else{
    echo $srcw;//Pid错误或无效
}

?>